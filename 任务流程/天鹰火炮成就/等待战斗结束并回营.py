"""
等待战斗结束并回营任务 - 放弃战斗并返回营地
"""
import time

from 任务流程.基础任务框架 import 基础任务, 任务上下文


class 等待战斗结束并回营任务(基础任务):
    """放弃战斗并返回营地"""

    def __init__(self, 上下文: '任务上下文'):
        super().__init__(上下文)
        # 模板识别器已在基类初始化

    def 执行(self) -> bool:
        """主执行流程"""
        上下文 = self.上下文
        上下文.置脚本状态("开始执行放弃战斗回营地操作", 3*60)

        self.点击放弃战斗按钮()
        self.点击确定()
        self.等待回营地按钮出现()
        return True

    def 点击放弃战斗按钮(self) -> bool:
        """点击放弃战斗按钮"""
        上下文 = self.上下文
        按钮区域 = (0, 0, 800, 600)
        模板路径 = "放弃战斗1.bmp|放弃战斗2.bmp|放弃战斗3.bmp"
        超时时间 = 30  # 等待30秒
        开始时间 = time.time()

        while time.time() - 开始时间 < 超时时间:
            # 获取按钮区域图像
            屏幕图像 = 上下文.op.获取屏幕图像cv(*按钮区域)
            # 执行模板匹配
            是否匹配, (x, y), _ = self.模板识别.执行匹配(屏幕图像, 模板路径, 相似度阈值=0.9)
            if 是否匹配:
                上下文.点击(x, y)
                return True

            # 间隔检测
            上下文.脚本延时(1000)

        return False

    def 点击确定(self) -> bool:
        """点击确定按钮"""
        上下文 = self.上下文
        按钮区域 = (0, 0, 800, 600)
        模板路径 = "点击确定1.bmp|点击确定2.bmp|点击确定3.bmp"
        超时时间 = 30  # 等待30秒
        开始时间 = time.time()

        while time.time() - 开始时间 < 超时时间:
            # 获取按钮区域图像
            屏幕图像 = 上下文.op.获取屏幕图像cv(*按钮区域)
            # 执行模板匹配
            是否匹配, (x, y), _ = self.模板识别.执行匹配(屏幕图像, 模板路径, 相似度阈值=0.9)
            if 是否匹配:
                上下文.点击(x, y)
                return True

            # 间隔检测
            上下文.脚本延时(1000)

        return False

    def 等待回营地按钮出现(self) -> bool:
        """使用模板匹配检测回营按钮"""
        上下文 = self.上下文

        按钮区域 = (0, 0, 800, 600)
        模板路径 = "回营1.bmp|回营.bmp|回营2.bmp|回营3.bmp|领取奖励.bmp|回营_领取奖励.bmp"
        超时时间 = 3*60  # 等待3分钟就超时
        开始时间 = time.time()

        是否已点击回营 = False
        while time.time() - 开始时间 < 超时时间:
            # 获取按钮区域图像
            屏幕图像 = 上下文.op.获取屏幕图像cv(*按钮区域)
            # 执行模板匹配
            是否匹配, (x, y), _ = self.模板识别.执行匹配(屏幕图像, 模板路径, 相似度阈值=0.9)
            if 是否匹配:
                是否已点击回营 = True
                上下文.点击(x, y)

            if 是否已点击回营 and not 是否匹配:
                return True

            # 间隔检测
            上下文.脚本延时(1000)

        return False
