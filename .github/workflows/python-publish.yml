name: è‡ªåŠ¨æ„å»ºå‘å¸ƒæµç¨‹

on:
  push:
    tags:
      - 'v[0-9]+.[0-9]+.[0-9]+*'  # æ ‡å‡†è¯­ä¹‰åŒ–ç‰ˆæœ¬
      - 'v*-test'  # æ˜ç¡®åŒ…å«testçš„æ ‡ç­¾
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-release:
    runs-on: windows-latest
    permissions:
      contents: write
      packages: write

    steps:
    # 1. æ£€å‡ºä»£ç 
    - name: æ£€å‡ºä»£ç åº“
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    # 2. é…ç½®Pythonç¯å¢ƒ
    - name: è®¾ç½®Pythonç¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.10.9'
        cache: 'pip'

    # 3. å®‰è£…ä¾èµ–
    - name: å®‰è£…é¡¹ç›®ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
        pip install pyinstaller

    # 4. æ‰§è¡Œæ„å»º
    - name: ä½¿ç”¨PyInstalleræ„å»º
      shell: pwsh
      run: |
        pyinstaller --noconfirm "è‡ªåŠ¨è„šæœ¬.spec"
        $files = Get-ChildItem dist -Recurse -File
        echo "ç”Ÿæˆæ–‡ä»¶åˆ—è¡¨ï¼š"
        $files | Format-Table FullName
        echo "æ€»æ–‡ä»¶æ•°: $($files.Count)"

    # 5. å‹ç¼©æ„å»ºç»“æœ
    - name: å‹ç¼©å‘å¸ƒæ–‡ä»¶
      shell: pwsh
      run: |
        $version = "${{ github.ref_name }}".Replace("v","")
        $zipName = "å‘å¸ƒåŒ…_v${version}_$(Get-Date -Format 'yyyyMMdd').zip"
        Compress-Archive -Path "./dist/*" -DestinationPath "./$zipName" -Force
        echo "å‹ç¼©åŒ…åç§°: $zipName"
        echo "ZIP_PATH=$zipName" >> $env:GITHUB_ENV

    # ç”Ÿæˆå½“å‰æ—¶é—´å­—ç¬¦ä¸²
    - name: ç”Ÿæˆæ„å»ºæ—¶é—´
      shell: pwsh
      run: |
        $æ—¶é—´ = Get-Date -Format 'yyyy-MM-dd HH:mm:ss'
        echo "BUILD_TIME=$æ—¶é—´" >> $env:GITHUB_ENV

    - name: ç”Ÿæˆ Release Body
      shell: bash
      run: |
        CURRENT_TAG=${GITHUB_REF#refs/tags/}
        PREVIOUS_TAG=$(git tag --sort=-creatordate | grep -v "^${CURRENT_TAG}$" | head -n 1)

        echo "å½“å‰ç‰ˆæœ¬: $CURRENT_TAG"
        echo "ä¸Šä¸€ä¸ªç‰ˆæœ¬: $PREVIOUS_TAG"

        # å¼€å§‹ç”Ÿæˆ Release Body
        cat > body.md << 'HEADER'
        ## ğŸ“¦ ç‰ˆæœ¬ä¿¡æ¯

        HEADER

        echo "- **ç‰ˆæœ¬å·**: \`$CURRENT_TAG\`" >> body.md
        echo "- **æ„å»ºæ—¶é—´**: ${{ env.BUILD_TIME }}" >> body.md
        echo "- **ä¸Šä¸€ç‰ˆæœ¬**: \`${PREVIOUS_TAG:-æ— }\`" >> body.md
        echo "" >> body.md

        # è·å–æäº¤åˆ—è¡¨
        if [ -z "$PREVIOUS_TAG" ]; then
          COMMITS=$(git log --pretty=format:"%h|%s|%an|%ad" --date=short)
          COMMIT_COUNT=$(git rev-list --count HEAD)
        else
          COMMITS=$(git log --pretty=format:"%h|%s|%an|%ad" --date=short ${PREVIOUS_TAG}..${CURRENT_TAG})
          COMMIT_COUNT=$(git rev-list --count ${PREVIOUS_TAG}..${CURRENT_TAG})
        fi

        echo "- **æäº¤æ•°é‡**: ${COMMIT_COUNT} ä¸ªæäº¤" >> body.md
        echo "" >> body.md

        # åˆ†ç±»æäº¤
        echo "## ğŸ“ æ›´æ–°å†…å®¹" >> body.md
        echo "" >> body.md

        # æ–°åŠŸèƒ½
        NEW_FEATURES=$(echo "$COMMITS" | grep -iE "\|.*(æ–°å¢|æ·»åŠ |æ”¯æŒ|feat|add|new)" | head -20 || true)
        if [ -n "$NEW_FEATURES" ]; then
          echo "### âœ¨ æ–°åŠŸèƒ½" >> body.md
          echo "$NEW_FEATURES" | while IFS='|' read -r hash msg author date; do
            echo "- ${msg} (\`${hash}\` by ${author})" >> body.md
          done
          echo "" >> body.md
        fi

        # Bugä¿®å¤
        BUG_FIXES=$(echo "$COMMITS" | grep -iE "\|.*(ä¿®å¤|ä¿®æ­£|fix|bug|repair)" | head -20 || true)
        if [ -n "$BUG_FIXES" ]; then
          echo "### ğŸ› Bug ä¿®å¤" >> body.md
          echo "$BUG_FIXES" | while IFS='|' read -r hash msg author date; do
            echo "- ${msg} (\`${hash}\` by ${author})" >> body.md
          done
          echo "" >> body.md
        fi

        # ä¼˜åŒ–æ”¹è¿›
        IMPROVEMENTS=$(echo "$COMMITS" | grep -iE "\|.*(ä¼˜åŒ–|æ”¹è¿›|æ”¹å–„|æå‡|refactor|improve|perf|update)" | head -20 || true)
        if [ -n "$IMPROVEMENTS" ]; then
          echo "### ğŸš€ ä¼˜åŒ–æ”¹è¿›" >> body.md
          echo "$IMPROVEMENTS" | while IFS='|' read -r hash msg author date; do
            echo "- ${msg} (\`${hash}\` by ${author})" >> body.md
          done
          echo "" >> body.md
        fi

        # å…¶ä»–æäº¤ï¼ˆæ’é™¤å·²åˆ†ç±»çš„ï¼‰
        OTHER_COMMITS=$(echo "$COMMITS" | grep -viE "\|.*(æ–°å¢|æ·»åŠ |æ”¯æŒ|feat|add|new|ä¿®å¤|ä¿®æ­£|fix|bug|repair|ä¼˜åŒ–|æ”¹è¿›|æ”¹å–„|æå‡|refactor|improve|perf|update)" | head -10 || true)
        if [ -n "$OTHER_COMMITS" ]; then
          echo "### ğŸ“‹ å…¶ä»–æ›´æ”¹" >> body.md
          echo "$OTHER_COMMITS" | while IFS='|' read -r hash msg author date; do
            echo "- ${msg} (\`${hash}\` by ${author})" >> body.md
          done
          echo "" >> body.md
        fi

        # å®Œæ•´æäº¤æ—¥å¿—ï¼ˆæŠ˜å ï¼‰
        echo "<details>" >> body.md
        echo "<summary>ğŸ“œ å®Œæ•´æäº¤æ—¥å¿—</summary>" >> body.md
        echo "" >> body.md
        echo "| æäº¤ | è¯´æ˜ | ä½œè€… | æ—¥æœŸ |" >> body.md
        echo "|------|------|------|------|" >> body.md
        echo "$COMMITS" | head -50 | while IFS='|' read -r hash msg author date; do
          echo "| \`${hash}\` | ${msg} | ${author} | ${date} |" >> body.md
        done
        echo "" >> body.md
        echo "</details>" >> body.md
        echo "" >> body.md

        # ä¸‹è½½è¯´æ˜
        echo "## ğŸ“¥ ä¸‹è½½è¯´æ˜" >> body.md
        echo "" >> body.md
        echo "1. ä¸‹è½½ä¸‹æ–¹çš„å‹ç¼©åŒ…" >> body.md
        echo "2. è§£å‹åˆ°ä»»æ„ç›®å½•" >> body.md
        echo "3. é…ç½®ç¯å¢ƒåæ‰§è¡Œ \`python UIå…¥å£.py\`" >> body.md
        echo "" >> body.md
        echo "---" >> body.md
        echo "*æ­¤ç‰ˆæœ¬ç”± GitHub Actions è‡ªåŠ¨æ„å»ºå‘å¸ƒ*" >> body.md

    - name: å‘å¸ƒåˆ°GitHub
      uses: softprops/action-gh-release@v1
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        tag_name: ${{ github.ref_name }}
        name: "ç‰ˆæœ¬ ${{ github.ref_name }}"
        body_path: ./body.md
#        files: |
#          ${{ env.ZIP_PATH }}
        draft: false
        prerelease: ${{ contains(github.ref, 'test') || contains(github.ref, 'beta') }}

    # 7. æ¸…ç†å·¥ä½œåŒº
    - name: æ¸…ç†å·¥ä½œç©ºé—´
      if: always()
      run: |
        Remove-Item -Recurse -Force build, dist, *.zip -ErrorAction SilentlyContinue
