# 02 - 核心架构

## 任务基类体系

### 任务上下文

**文件**：`任务流程/基础任务框架.py`

```python
@dataclass
class 任务上下文:
    机器人标志: str
    数据库: 任务数据库
    消息队列: queue.Queue
    继续事件: threading.Event
    停止事件: threading.Event
    op: op类                    # 屏幕图像获取
    雷电模拟器: 雷电模拟器操作类
    键盘: 键盘控制器
    鼠标: 鼠标控制器
    置脚本状态: Callable        # 日志回调
```

### 基础任务类

```python
class 基础任务(ABC):
    """统一的任务基类，自动初始化常用工具"""

    def __init__(self, 上下文: 任务上下文):
        self.上下文 = 上下文
        # 自动初始化检测引擎
        self.模板识别 = 模板匹配引擎()
        self.ocr引擎 = 安全OCR引擎()
        self.检测器 = 线程安全YOLO检测器()
        # 便捷属性
        self.数据库 = 上下文.数据库
        self.机器人标志 = 上下文.机器人标志

    @abstractmethod
    def 执行(self) -> bool:
        """返回True继续下一任务，False终止流程"""
        pass

    def 异常处理(self, 异常, 是否重启游戏=True, 是否重启机器人=True):
        """委托给上下文统一处理"""
        self.上下文.处理异常(self.__class__.__name__, 异常, 是否重启游戏, 是否重启机器人)
```

**重要约定**：
- `夜世界基础任务` 是 `基础任务` 的别名（向后兼容）
- 方法签名：`def 执行(self) -> bool`（不再传入上下文参数）
- 异常处理：抛出异常在 `执行()` 中捕获，调用 `self.异常处理(e)`

### 上下文方法

| 方法 | 说明 |
|------|------|
| `上下文.脚本延时(毫秒)` | 线程安全延时，支持暂停/停止 |
| `上下文.点击(x, y, 延时, 是否精确点击)` | 模拟点击，自动加随机偏移 |
| `上下文.滑动屏幕(起点, 终点)` | 贝塞尔曲线滑动 |
| `上下文.置脚本状态(msg)` | 记录日志 |
| `上下文.发送重启请求()` | 请求重启机器人 |
| `上下文.处理异常(任务名, 异常, 重启游戏, 重启机器人)` | 统一异常处理 |

## 数据库结构

**文件**：`数据库/任务数据库.py`

### 表结构

```sql
-- 运行时状态表
运行时状态(记录ID, 机器人标志, 记录时间, 状态类型, 状态值)

-- 任务日志表
任务日志(记录ID, 机器人标志, 日志内容, 记录时间, 下次超时)

-- 机器人设置表
机器人设置(机器人标志, 设置JSON)

-- 系统配置表（用于协议同意状态等）
系统配置(配置键, 配置值, 更新时间)
```

### 机器人设置数据类

**详细说明请参考 [03-UI配置系统](./03-UI配置系统.md)**

核心字段包括：
- 雷电模拟器索引
- 服务器（国际服/国服）
- 进攻资源阈值
- 刷墙设置
- 英雄/建筑升级配置
- 等等...

### 数据库API

```python
# 设置管理
数据库.保存机器人设置(机器人标志, 设置对象)
数据库.获取机器人设置(机器人标志)
数据库.查询所有机器人设置()
数据库.删除机器人设置(机器人标志)

# 日志管理
数据库.记录日志(机器人标志, 日志内容, 下次超时)
数据库.读取最后日志(机器人标志)
数据库.查询日志历史(机器人标志, 起始时间, 截止时间, 最大条数)

# 状态管理
数据库.更新状态(机器人标志, 状态类型, 状态数据)
数据库.获取最新完整状态(机器人标志)
数据库.获取状态历史(机器人标志, 状态类型, 起始时间, 截止时间, 最大条数)

# 系统配置
数据库.检查协议是否已同意()
数据库.保存协议同意记录()
数据库.撤销协议同意()
```

## 检测引擎

### 模板匹配

```python
是否匹配, (x, y), 相似度 = self.模板识别.执行匹配(
    图像,
    "模板.bmp|模板2.bmp",  # 支持多模板
    0.9  # 相似度阈值
)
```

### OCR识别

```python
结果, _ = self.ocr引擎(图像)
# 结果格式: [[[坐标], 文本], ...]
```

### YOLO检测

```python
检测列表 = self.检测器.检测(图像)
# 结果格式: [{类别名称, 裁剪坐标, 置信度}, ...]
```

## 机器人线程模型

**文件**：`线程/自动化机器人.py`

- 每个机器人运行在独立线程
- 支持启动、暂停、继续、停止
- 异常自动恢复（重启游戏/重启机器人）
- 消息队列通信
