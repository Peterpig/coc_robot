# 03 - UI配置系统（自动生成）

> 🎯 **核心特性**：通过 dataclass metadata 自动生成配置面板，无需手动编写UI代码！

## 概述

配置管理面板采用**元数据驱动**的设计模式，只需在 `机器人设置` 数据类中定义字段和 metadata，UI会自动生成对应的控件。

**文件位置**：
- 数据模型：`数据库/任务数据库.py` → `class 机器人设置`
- UI面板：`界面/配置管理面板.py` → `class 配置管理面板`

## 快速开始

### 添加新配置字段（3步完成）

#### 1. 在 `机器人设置` 中定义字段

```python
# 数据库/任务数据库.py

@dataclass
class 机器人设置:
    # ... 现有字段 ...

    # 添加新字段
    新功能开关: bool = field(
        default=False,
        metadata={
            "显示名称": "是否启用新功能",
            "描述": "这是新功能的开关，启用后会自动执行某某操作",
            "UI类型": "bool"
        }
    )

    新功能阈值: int = field(
        default=1000,
        metadata={
            "显示名称": "新功能阈值",
            "描述": "当数值超过此阈值时触发新功能",
            "UI类型": "spinbox",
            "最小值": 0,
            "最大值": 10000,
            "步进": 100
        }
    )
```

#### 2. 无需修改UI代码

配置面板会**自动**生成对应的控件！

#### 3. 启动程序测试

```bash
python UI入口.py
```

配置管理页面会自动显示新增的字段。

## 支持的UI类型

### 1. entry - 文本输入框

**适用于**：字符串、数字（int/float）

```python
字段名: str = field(
    default="默认值",
    metadata={
        "显示名称": "显示的标签",
        "描述": "鼠标悬停提示文本",
        "UI类型": "entry"
    }
)
```

### 2. spinbox - 数字微调框

**适用于**：整数（int）

```python
数量: int = field(
    default=10,
    metadata={
        "显示名称": "数量",
        "描述": "设置数量，可使用上下箭头调整",
        "UI类型": "spinbox",
        "最小值": 0,
        "最大值": 100,
        "步进": 5
    }
)
```

**元数据参数**：
- `最小值` - 最小可选值
- `最大值` - 最大可选值
- `步进` - 每次递增/递减的步长

### 3. combo - 下拉选择框

**适用于**：字符串（有限选项）

```python
服务器: str = field(
    default="国际服",
    metadata={
        "显示名称": "服务器",
        "描述": "选择游戏服务器版本",
        "UI类型": "combo",
        "选项": ["国际服", "国服", "韩服"]
    }
)
```

**元数据参数**：
- `选项` - 可选值列表

### 4. bool - 布尔开关

**适用于**：布尔值（bool）

```python
启用功能: bool = field(
    default=False,
    metadata={
        "显示名称": "是否启用功能",
        "描述": "启用后会自动执行该功能",
        "UI类型": "bool"
    }
)
```

显示为**"开启/关闭"**下拉框。

### 5. editable_list - 可编辑列表

**适用于**：字符串列表（List[str]）

```python
欲升级的英雄或建筑: List[str] = field(
    default_factory=lambda: ["弓箭女皇", "亡灵王子"],
    metadata={
        "显示名称": "欲升级的英雄或建筑",
        "描述": "选择想要升级的英雄或建筑，可多选、添加自定义项",
        "UI类型": "editable_list",
        "默认选项": ["野蛮人之王", "弓箭女皇", "亡灵王子", "飞盾战神", "大守护者"]
    }
)
```

**功能特点**：
- 双列表UI（可选项 ↔ 已选项）
- 支持多选添加/移除
- 支持用户自定义添加新项目

**元数据参数**：
- `默认选项` - 预设的可选项列表

### 6. hidden - 隐藏字段

**适用于**：不需要在UI中显示的字段

```python
部落冲突包名: str | None = field(
    default=None,
    metadata={
        "显示名称": "包名",
        "描述": "游戏包名，自动根据服务器设置",
        "UI类型": "hidden"
    }
)
```

该字段不会在UI中显示，但仍会保存到数据库。

## 完整示例

### 示例：添加"自动捐兵"功能

```python
# 数据库/任务数据库.py

@dataclass
class 机器人设置:
    # ... 现有字段 ...

    # 1. 开关
    是否自动捐兵: bool = field(
        default=False,
        metadata={
            "显示名称": "自动捐兵",
            "描述": "启用后会自动捐赠部落请求的兵种",
            "UI类型": "bool"
        }
    )

    # 2. 捐赠策略
    捐兵策略: str = field(
        default="优先捐高级兵",
        metadata={
            "显示名称": "捐兵策略",
            "描述": "选择捐兵的优先级策略",
            "UI类型": "combo",
            "选项": ["优先捐高级兵", "优先捐低级兵", "按请求捐"]
        }
    )

    # 3. 可捐兵种列表
    可捐兵种: List[str] = field(
        default_factory=lambda: ["弓箭手", "巨人"],
        metadata={
            "显示名称": "可捐兵种",
            "描述": "选择可以捐赠的兵种，可自定义添加",
            "UI类型": "editable_list",
            "默认选项": ["野蛮人", "弓箭手", "巨人", "法师", "龙"]
        }
    )

    # 4. 每日捐兵上限
    每日捐兵上限: int = field(
        default=100,
        metadata={
            "显示名称": "每日捐兵上限",
            "描述": "每天最多捐赠的次数，0表示不限制",
            "UI类型": "spinbox",
            "最小值": 0,
            "最大值": 500,
            "步进": 10
        }
    )
```

**无需其他修改**，启动程序后配置面板会自动显示这4个新字段！

## 数据库字段迁移

当你重命名字段时，系统会自动迁移旧数据。

### 字段重命名示例

```python
# 数据库/任务数据库.py

class 任务数据库:
    def _执行数据迁移(self):
        """执行数据库字段迁移"""
        字段映射 = {
            "欲升级的英雄": "欲升级的英雄或建筑",  # 旧字段名 -> 新字段名
            # 添加更多映射...
        }
        # ... 迁移逻辑（已实现）
```

**自动迁移时机**：数据库初始化时（`任务数据库.__init__`）

## 元数据字段规范

所有字段的 metadata 应包含：

| 键 | 必需 | 说明 | 示例 |
|---|-----|------|------|
| `显示名称` | ✅ | UI上显示的标签 | `"模拟器索引"` |
| `描述` | ✅ | 鼠标悬停提示 | `"对应雷电多开器中的模拟器ID"` |
| `UI类型` | ✅ | 控件类型 | `"spinbox"` |
| `最小值` | ❌ | spinbox专用 | `0` |
| `最大值` | ❌ | spinbox专用 | `99` |
| `步进` | ❌ | spinbox专用 | `1` |
| `选项` | ❌ | combo专用 | `["选项1", "选项2"]` |
| `默认选项` | ❌ | editable_list专用 | `["默认项1", "默认项2"]` |

## 滚动支持

配置面板自动支持鼠标滚轮滚动：
- ✅ 鼠标在配置区域的任意位置都能滚动
- ✅ 所有控件（输入框、列表）都响应滚轮
- ✅ 不影响其他窗口的滚动行为

## 最佳实践

### ✅ 推荐做法

1. **字段命名清晰**
   ```python
   是否启用新功能: bool  # ✅ 清晰易懂
   ```

2. **描述详细**
   ```python
   metadata={
       "描述": "启用后会自动检测并升级英雄，每小时检查一次"  # ✅ 详细说明
   }
   ```

3. **合理的默认值**
   ```python
   default=False  # ✅ 新功能默认关闭，避免误操作
   ```

4. **使用合适的UI类型**
   ```python
   # 有限选项用 combo
   服务器: str = field(metadata={"UI类型": "combo", "选项": [...]})

   # 数字范围用 spinbox
   数量: int = field(metadata={"UI类型": "spinbox", "最小值": 0, "最大值": 100})
   ```

### ❌ 避免的做法

1. **不要使用模糊的字段名**
   ```python
   flag: bool  # ❌ 不清楚用途
   ```

2. **不要省略描述**
   ```python
   metadata={"UI类型": "bool"}  # ❌ 缺少描述
   ```

3. **不要使用不合理的默认值**
   ```python
   default=999999  # ❌ 过大的默认值可能导致问题
   ```

## 故障排除

### 问题1：新增字段没有显示

**检查**：
1. metadata 中是否包含 `UI类型`
2. `UI类型` 是否拼写正确
3. 是否设置为 `"hidden"`

### 问题2：修改字段名后报错

**解决**：在 `_执行数据迁移()` 中添加字段映射

```python
字段映射 = {
    "旧字段名": "新字段名"
}
```

### 问题3：类型转换错误

**检查**：字段类型与 UI类型是否匹配
- `bool` → `"bool"`
- `int` → `"entry"` 或 `"spinbox"`
- `str` → `"entry"` 或 `"combo"`
- `List[str]` → `"editable_list"`

## 扩展UI类型

如需添加新的UI控件类型，修改 `界面/配置管理面板.py`：

```python
# 1. 在 _创建控件() 中添加新类型
elif UI类型 == "my_custom_type":
    控件 = MyCustomWidget(父容器, ...)
    return 控件

# 2. 在 _获取控件值() 中添加取值逻辑
if UI类型 == "my_custom_type":
    原始值 = 控件.get_custom_value()

# 3. 在 _设置控件值() 中添加赋值逻辑
if UI类型 == "my_custom_type":
    控件.set_custom_value(值)
```

## 参考实现

完整示例请查看：
- `数据库/任务数据库.py` → `class 机器人设置`
- `界面/配置管理面板.py` → `class 配置管理面板`
