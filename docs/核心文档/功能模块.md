# 05 - 功能模块

## 用户协议功能

**位置**：`UI入口.py`

### 核心方法

- `显示用户协议窗口()` - 首次启动显示协议弹窗
- `数据库.检查协议是否已同意()` - 检查协议状态
- `数据库.保存协议同意记录()` - 保存同意记录
- `数据库.撤销协议同意()` - 撤销同意（菜单入口）

### 菜单栏

**设置** → 撤销协议同意 / 查看用户协议

### 协议内容

协议采用正式法律文书格式，包含九条条款：
1. 服务范围与性质
2. 用户责任与义务
3. 风险警告
4. 免责声明
5. 知识产权
6. 数据隐私
7. 法律适用与争议解决
8. 协议变更
9. 其他条款

## 天鹰火炮成就刷取

**位置**：`任务流程/天鹰火炮成就/`

### 功能说明

自动搜索敌人村庄中的天鹰火炮，使用雷电法术进行11次精准攻击，用于刷取"天鹰艺术家"等相关成就。

### 目录结构

```
任务流程/天鹰火炮成就/
├── __init__.py           # 任务链入口（刷天鹰火炮任务）
├── 天鹰火炮检测器.py      # YOLO v8 ONNX检测器
├── 天鹰火炮进攻任务.py    # 搜索+检测+攻击逻辑
├── 等待战斗结束并回营.py  # 放弃战斗回营
└── 模型/
    └── best.pt           # YOLO模型（首次运行自动转ONNX）
```

### 任务流程

1. 打开进攻页面（复用主世界打鱼任务）
2. 循环搜索敌人（最多50次）
3. 使用YOLO v8检测天鹰火炮位置
4. 选中雷电法术，攻击11次（±5像素抖动，模拟人类）
5. 放弃战斗并返回营地

### 使用方法

**GUI方式**：
在配置管理中将"是否刷天鹰火炮"设置为"开启"

**命令行方式**：
```bash
python 主入口.py 是否刷天鹰火炮
```

### 技术特点

- 独立的YOLO v8检测器（与主项目YOLO v5隔离）
- 自动模型转换（PT→ONNX，支持GPU/CPU）
- 小目标过滤（宽≥20, 高≥20, 面积≥400）
- 置信度阈值：0.20
- 攻击位置随机抖动（±5像素），模拟人类操作

## 主世界打鱼

**位置**：`任务流程/主世界打鱼/`

### 功能说明

自动搜索合适的村庄进行进攻，掠夺资源。

### 核心流程

1. 检测是否有可用工人
2. 打开进攻页面
3. 搜索村庄（检测资源和边缘比例）
4. 满足条件后下兵进攻
5. 等待战斗结束
6. 返回营地

### 配置项

- `欲进攻的最小资源` - 资源总量阈值
- `欲进攻资源建筑靠近地图边缘最小比例` - 边缘比例（0-1）

## 夜世界打鱼

**位置**：`任务流程/夜世界/`

### 功能说明

自动进行夜世界进攻，完成每日任务。

### 配置项

- `是否刷夜世界` - 是否启用夜世界打鱼

## 建筑升级

**位置**：`任务流程/建筑升级/`

### 功能说明

自动升级英雄和建筑。

### 英雄升级

**配置**：
- `欲升级的英雄或建筑` - 选择要升级的英雄列表
- 支持自定义添加建筑名称

**流程**：
1. 检测英雄是否可升级
2. 点击英雄头像
3. 点击升级按钮
4. 确认升级

### 建筑升级

**配置**：
- `是否升级建议升级的建筑` - 是否自动升级系统推荐的建筑
- `建筑升级检查间隔` - 检查间隔（小时），0表示每次都检查

## 升级城墙

**位置**：`任务流程/升级城墙.py`

### 功能说明

当金币或圣水超过阈值时，自动升级城墙。

### 配置项

- `开启刷墙` - 是否启用刷墙功能
- `刷墙起始金币` - 金币阈值
- `刷墙起始圣水` - 圣水阈值

### 流程

1. 检测资源是否超过阈值
2. 检测可升级的城墙
3. 点击城墙
4. 点击升级按钮
5. 确认升级

## 世界跳转

**位置**：`任务流程/世界跳转/`

### 功能说明

在主世界和夜世界之间切换。

### 方法

```python
from 任务流程.世界跳转 import 主世界跳转到夜世界, 夜世界跳转到主世界

# 跳转到夜世界
主世界跳转到夜世界(上下文).执行()

# 跳转到主世界
夜世界跳转到主世界(上下文).执行()
```

## 启动模拟器

**位置**：`任务流程/启动模拟器.py`

### 功能说明

自动启动雷电模拟器并启动游戏。

### 流程

1. 检查模拟器是否已运行
2. 如未运行，启动模拟器
3. 等待模拟器启动完成
4. 启动部落冲突游戏

## 检测游戏登录状态

**位置**：`任务流程/检测游戏登录状态.py`

### 功能说明

检测游戏是否已登录到主界面。

### 检测方式

- 模板匹配：检测主界面特征图标
- OCR识别：识别界面文本
- YOLO检测：检测特定游戏元素

## 更新主世界账号资源状态

**位置**：`任务流程/更新主世界账号资源状态.py`

### 功能说明

定期更新并记录账号的资源状态。

### 记录内容

- 金币
- 圣水
- 暗黑重油
- 建筑工人状态
- 升级队列

### 存储位置

数据保存到数据库的 `运行时状态` 表，状态类型为 `"家乡资源"`。
