# 提交贡献（PR流程详解）

> 本文档详细讲解如何将你的代码贡献给项目，适合第一次提交PR的开发者。

## 🎯 什么是PR？

**PR = Pull Request（拉取请求）**

简单理解：
- 你在自己的仓库里写了代码
- 想让这些代码合并到主项目
- 发起一个"请求"，让项目维护者review并合并

## 📋 准备工作清单

在提交PR前，确保：

- [ ] 代码已测试通过
- [ ] 添加了必要的注释
- [ ] 遵循项目代码规范
- [ ] 更新了相关文档
- [ ] 提交信息清晰明确

## 🚀 完整PR流程（Step by Step）

### 第1步：Fork项目

1. 打开项目页面：https://github.com/qilishidai/coc_robot
2. 点击右上角的 **Fork** 按钮
3. 等待几秒，你的账号下会有一个副本

**结果**：
```
原项目：github.com/qilishidai/coc_robot
你的副本：github.com/你的用户名/coc_robot
```

### 第2步：克隆你的副本

打开终端/命令行，执行：

```bash
# 克隆你Fork的仓库（替换"你的用户名"）
git clone https://github.com/你的用户名/coc_robot.git

# 进入项目目录
cd coc_robot
```

### 第3步：配置远程仓库

```bash
# 查看当前远程仓库
git remote -v

# 添加上游仓库（原项目）
git remote add upstream https://github.com/qilishidai/coc_robot.git

# 再次查看，应该有两个远程仓库：
# origin - 你的副本
# upstream - 原项目
git remote -v
```

**输出示例**：
```
origin    https://github.com/你的用户名/coc_robot.git (fetch)
origin    https://github.com/你的用户名/coc_robot.git (push)
upstream  https://github.com/qilishidai/coc_robot.git (fetch)
upstream  https://github.com/qilishidai/coc_robot.git (push)
```

### 第4步：创建功能分支

**不要直接在main分支上修改！**

```bash
# 确保在main分支
git checkout main

# 拉取最新代码
git pull upstream main

# 创建新分支（命名要有意义）
git checkout -b feature/领取每日礼物

# 查看当前分支
git branch
```

**分支命名规范**：
- `feature/功能名` - 新功能
- `bugfix/问题描述` - 修复bug
- `docs/文档更新` - 文档修改

**示例**：
```bash
git checkout -b feature/自动捐兵
git checkout -b bugfix/修复识别错误
git checkout -b docs/更新开发文档
```

### 第5步：开发你的功能

按照 [开发第一个任务](./02-开发第一个任务.md) 教程，完成你的代码。

**开发过程中**：

```bash
# 1. 查看修改了哪些文件
git status

# 2. 查看具体修改内容
git diff

# 3. 阶段性提交（避免一次提交太多）
git add 任务流程/领取每日礼物.py
git commit -m "添加领取每日礼物任务"

# 4. 如果修改了多个文件
git add 模板/每日礼物按钮.bmp
git commit -m "添加每日礼物按钮模板"
```

### 第6步：测试你的代码

**必须测试！**

```bash
# 运行测试脚本
python 测试_领取每日礼物.py

# 运行主程序测试
python UI入口.py
```

**测试清单**：
- [ ] 任务可以正常执行
- [ ] 没有报错
- [ ] 日志输出正常
- [ ] 不影响其他功能

### 第7步：完善提交信息

#### 好的提交信息

```bash
git commit -m "添加领取每日礼物任务

- 实现自动检测每日礼物按钮
- 点击按钮领取礼物
- 添加相关模板图片
- 添加单元测试

测试：已在国际服、国服测试通过"
```

#### 不好的提交信息

```bash
git commit -m "update"  # ❌ 太简单
git commit -m "修改了一些代码"  # ❌ 不清楚修改了什么
git commit -m "fix bug"  # ❌ 什么bug？
```

#### 提交信息规范

**格式**：
```
<类型>: <简短描述>

<详细说明>
- 改动点1
- 改动点2

<测试说明>
```

**类型标签**：
- `feat:` - 新功能
- `fix:` - 修复bug
- `docs:` - 文档更新
- `style:` - 代码格式（不影响功能）
- `refactor:` - 重构
- `test:` - 测试相关

**示例**：
```bash
git commit -m "feat: 添加自动捐兵功能

实现内容：
- 检测部落请求
- 自动选择兵种捐赠
- 支持自定义捐兵策略
- 添加每日捐兵上限

测试：已测试1000次捐兵，成功率98%"
```

### 第8步：推送到你的仓库

```bash
# 推送到你Fork的仓库
git push origin feature/领取每日礼物
```

**如果是第一次推送该分支**：
```bash
git push -u origin feature/领取每日礼物
```

### 第9步：创建Pull Request

1. 打开你的仓库页面：`github.com/你的用户名/coc_robot`
2. 会看到一个黄色提示框："Compare & pull request"
3. 点击 **Compare & pull request** 按钮
4. 填写PR信息（见下文）
5. 点击 **Create pull request**

#### PR标题

清晰简洁，说明做了什么：

**好的标题**：
```
✅ feat: 添加自动领取每日礼物功能
✅ fix: 修复天鹰火炮检测失败问题
✅ docs: 更新开发文档，添加PR流程说明
```

**不好的标题**：
```
❌ 更新
❌ 修改代码
❌ PR
```

#### PR描述

使用以下模板：

```markdown
## 📋 改动说明

简要描述你做了什么改动。

## 🎯 解决的问题

- 解决了 #issue号（如果有关联issue）
- 或者：实现了XX功能

## 🔧 改动内容

- [ ] 添加了 `任务流程/领取每日礼物.py`
- [ ] 添加了模板图片 `模板/每日礼物按钮.bmp`
- [ ] 更新了文档 `docs/xxx.md`

## ✅ 测试情况

- [x] 本地测试通过
- [x] 在国际服测试通过
- [ ] 在国服测试通过（未测试）

测试截图：（如果有）

## 📝 其他说明

有什么需要特别说明的地方。

## ✏️ Co-Authored-By

Co-Authored-By: 你的名字 <your-email@example.com>
```

**完整示例**：

```markdown
## 📋 改动说明

添加了自动领取每日礼物的功能，检测"每日礼物"按钮并自动点击领取。

## 🎯 解决的问题

实现了 #123 提出的自动领取每日礼物需求。

## 🔧 改动内容

- [x] 添加了 `任务流程/领取每日礼物.py` 任务类
- [x] 添加了 `模板/每日礼物按钮.bmp` 模板图片
- [x] 添加了测试脚本 `测试_领取每日礼物.py`
- [x] 更新了 `线程/自动化机器人.py`，集成新任务
- [x] 更新了开发文档

## ✅ 测试情况

- [x] 本地测试通过（Windows 10）
- [x] 在国际服测试通过（连续测试50次，成功率100%）
- [x] 模板匹配相似度阈值设为0.8，识别准确

测试截图：
![image](https://...)

## 📝 其他说明

- 模板图片使用800x600分辨率截取
- 建议在主流程开始阶段调用此任务
- 如果已领取过，任务会跳过并返回True

## ✏️ Co-Authored-By

Co-Authored-By: 张三 <zhangsan@example.com>
```

### 第10步：等待Review

提交PR后：

1. **等待维护者Review**
   - 维护者会检查你的代码
   - 可能会提出修改建议

2. **根据反馈修改**
   - 在本地修改代码
   - 提交并推送：
     ```bash
     git add .
     git commit -m "根据review修改：优化相似度阈值"
     git push origin feature/领取每日礼物
     ```
   - PR会自动更新

3. **合并**
   - 如果一切OK，维护者会合并你的PR
   - 恭喜！你的代码进入主项目了！

## 🔄 保持同步

在开发过程中，主项目可能有更新，需要保持同步：

```bash
# 1. 切换到main分支
git checkout main

# 2. 拉取上游更新
git pull upstream main

# 3. 推送到你的仓库
git push origin main

# 4. 切换回功能分支
git checkout feature/领取每日礼物

# 5. 合并main分支的更新
git merge main

# 6. 如果有冲突，解决冲突后提交
git add .
git commit -m "合并main分支最新代码"
git push origin feature/领取每日礼物
```

## ⚠️ 常见错误

### 错误1：直接在main分支开发

**问题**：
```bash
# ❌ 错误做法
git checkout main
# 直接修改代码
git commit -m "添加功能"
```

**解决**：
```bash
# ✅ 正确做法
git checkout -b feature/新功能
# 修改代码
git commit -m "添加功能"
```

### 错误2：一次提交太多改动

**问题**：
```bash
# ❌ 一次提交了10个文件，100行代码
git add .
git commit -m "大改动"
```

**解决**：
```bash
# ✅ 分多次提交
git add 任务流程/任务1.py
git commit -m "添加任务1"

git add 任务流程/任务2.py
git commit -m "添加任务2"

git add docs/xxx.md
git commit -m "更新文档"
```

### 错误3：提交信息不清楚

**问题**：
```bash
# ❌ 看不懂做了什么
git commit -m "update"
git commit -m "fix"
```

**解决**：
```bash
# ✅ 清晰明确
git commit -m "feat: 添加自动领取每日礼物功能"
git commit -m "fix: 修复模板匹配相似度阈值过高问题"
```

### 错误4：忘记测试

**问题**：
- 提交了未测试的代码
- PR被拒绝

**解决**：
- 提交前必须本地测试
- 确保功能正常工作
- 不影响其他功能

## 📋 PR检查清单

提交PR前，对照检查：

### 代码质量
- [ ] 代码已测试通过
- [ ] 没有语法错误
- [ ] 遵循项目代码规范
- [ ] 添加了必要的注释
- [ ] 没有调试代码（print、断点等）

### 文档
- [ ] 更新了相关文档
- [ ] README需要更新的已更新
- [ ] 添加了使用说明

### Git
- [ ] 提交信息清晰
- [ ] 一个PR只做一件事
- [ ] 没有提交不相关的文件
- [ ] 分支名称有意义

### 测试
- [ ] 本地测试通过
- [ ] 添加了测试用例（如果需要）
- [ ] 不影响现有功能

## 🎓 进阶技巧

### 1. 使用.gitignore

避免提交不必要的文件：

```bash
# 查看.gitignore文件
cat .gitignore

# 常见要忽略的文件：
*.db          # 数据库文件
*.pyc         # Python编译文件
__pycache__/  # 缓存目录
.vscode/      # IDE配置
debug_*.png   # 调试图片
```

### 2. 修改最后一次提交

如果提交后发现有小问题：

```bash
# 修改代码
vim 任务流程/领取每日礼物.py

# 追加到最后一次提交
git add 任务流程/领取每日礼物.py
git commit --amend --no-edit

# 强制推送（注意：只在自己的分支上使用）
git push -f origin feature/领取每日礼物
```

### 3. 交互式暂存

选择性暂存修改：

```bash
# 交互式添加
git add -p

# 会提示每个修改块：
# y - 暂存这个修改
# n - 不暂存
# s - 拆分成更小的块
# q - 退出
```

### 4. 查看提交历史

```bash
# 查看提交历史
git log --oneline

# 查看某个文件的修改历史
git log --oneline 任务流程/领取每日礼物.py

# 图形化显示分支
git log --oneline --graph --all
```

## 💡 最佳实践

1. **小步快跑**
   - 频繁提交，每次提交做一件事
   - 更容易review和回滚

2. **清晰命名**
   - 分支名、提交信息都要清晰
   - 让别人一看就懂

3. **及时同步**
   - 定期拉取上游更新
   - 避免大规模冲突

4. **详细描述**
   - PR描述要详细
   - 说明做了什么、为什么、如何测试

5. **主动沟通**
   - 有疑问就在PR评论区提问
   - 及时回复review意见

## ❓ 常见问题

### Q: 我的PR被拒绝了怎么办？

**A**: 不要灰心！看看拒绝原因：
- 代码质量问题 → 按要求修改
- 功能重复 → 确认是否已有类似功能
- 不符合项目方向 → 和维护者讨论

### Q: 如何撤销已推送的提交？

**A**:
```bash
# 回退到上一个提交
git reset --hard HEAD^

# 强制推送（慎用！）
git push -f origin feature/分支名
```

### Q: PR合并后还能修改吗？

**A**: 不能。PR合并后：
- 代码已进入主分支
- 如需修改，提交新PR

### Q: 可以同时提交多个PR吗？

**A**: 可以，但：
- 每个PR一个功能分支
- 互不影响最好

```bash
# PR1
git checkout -b feature/功能1
# 开发、提交、推送

# PR2
git checkout main
git checkout -b feature/功能2
# 开发、提交、推送
```

## 🔗 相关资源

- [Git官方文档](https://git-scm.com/doc)
- [GitHub PR文档](https://docs.github.com/en/pull-requests)
- [项目贡献指南](../README.md)
- [开发规范](../核心文档/开发规范.md)

## 🎉 感谢你的贡献！

每一个PR都让项目变得更好！

遇到问题随时在issue区提问，社区会帮助你！
