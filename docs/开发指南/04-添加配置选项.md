# 添加配置选项

> 本教程教你如何为你的任务添加可配置的选项，让用户可以在UI界面中轻松设置。

## 🎯 为什么需要配置选项？

假设你开发了"自动领取每日礼物"任务，但不同用户有不同需求：
- 有人希望每天领取1次
- 有人希望领取多次
- 有人希望指定领取时间

这时就需要**可配置的选项**！

## ✨ 核心特性

本项目采用**元数据驱动**的UI自动生成：
- ✅ 只需在数据类中添加字段
- ✅ UI会自动生成对应的控件
- ✅ 无需手动编写UI代码

## 📝 快速开始（3步完成）

### 第1步：定义字段

打开 `数据库/任务数据库.py`，找到 `class 机器人设置`，添加你的字段：

```python
@dataclass
class 机器人设置:
    # ... 现有字段 ...

    # 添加新字段
    是否领取每日礼物: bool = field(
        default=True,  # 默认值
        metadata={
            "显示名称": "是否领取每日礼物",
            "描述": "启用后会自动领取每日礼物",
            "UI类型": "bool"
        }
    )

    每日礼物领取次数: int = field(
        default=1,
        metadata={
            "显示名称": "每日礼物领取次数",
            "描述": "每天最多领取的次数",
            "UI类型": "spinbox",
            "最小值": 1,
            "最大值": 10,
            "步进": 1
        }
    )
```

### 第2步：无需修改UI代码

**UI会自动生成！** 配置面板会自动显示这两个新字段。

### 第3步：在任务中使用配置

在你的任务代码中读取配置：

```python
class 领取每日礼物(基础任务):
    def 执行(self) -> bool:
        try:
            上下文 = self.上下文

            # 读取配置
            设置 = self.数据库.获取机器人设置(self.机器人标志)

            if not 设置.是否领取每日礼物:
                上下文.置脚本状态("功能已禁用")
                return True  # 跳过

            领取次数 = 设置.每日礼物领取次数

            # 使用配置
            for i in range(领取次数):
                上下文.置脚本状态(f"领取第{i+1}次礼物")
                # ... 领取逻辑

            return True

        except Exception as e:
            self.异常处理(e)
            return False
```

**完成！** 现在用户可以在配置面板中设置了！

## 🎨 支持的UI类型

### 1. bool - 开关

```python
启用功能: bool = field(
    default=False,
    metadata={
        "显示名称": "是否启用功能",
        "描述": "启用后会自动执行",
        "UI类型": "bool"
    }
)
```

**UI显示**：下拉框（开启/关闭）

### 2. int - 整数

**方式1：普通输入框**

```python
数量: int = field(
    default=100,
    metadata={
        "显示名称": "数量",
        "描述": "设置数量值",
        "UI类型": "entry"
    }
)
```

**方式2：数字微调框（推荐）**

```python
数量: int = field(
    default=100,
    metadata={
        "显示名称": "数量",
        "描述": "设置数量值，可使用上下箭头调整",
        "UI类型": "spinbox",
        "最小值": 0,
        "最大值": 1000,
        "步进": 10
    }
)
```

### 3. str - 字符串

**方式1：自由输入**

```python
自定义文本: str = field(
    default="默认值",
    metadata={
        "显示名称": "自定义文本",
        "描述": "输入自定义文本",
        "UI类型": "entry"
    }
)
```

**方式2：下拉选择（推荐）**

```python
服务器: str = field(
    default="国际服",
    metadata={
        "显示名称": "服务器",
        "描述": "选择游戏服务器",
        "UI类型": "combo",
        "选项": ["国际服", "国服", "韩服"]
    }
)
```

### 4. List[str] - 字符串列表

```python
欲升级的英雄: List[str] = field(
    default_factory=lambda: ["弓箭女皇", "亡灵王子"],
    metadata={
        "显示名称": "欲升级的英雄",
        "描述": "选择想要升级的英雄，可多选、添加自定义项",
        "UI类型": "editable_list",
        "默认选项": ["野蛮人之王", "弓箭女皇", "亡灵王子", "飞盾战神", "大守护者"]
    }
)
```

**UI显示**：双列表控件（可选项 ↔ 已选项）
**功能**：支持多选、移除、自定义添加

### 5. hidden - 隐藏字段

```python
内部字段: str = field(
    default="自动计算",
    metadata={
        "UI类型": "hidden"  # 不会在UI中显示
    }
)
```

## 📋 元数据字段说明

| 键 | 必需 | 说明 | 示例 |
|---|-----|------|------|
| `显示名称` | ✅ | UI上显示的标签 | `"是否开启功能"` |
| `描述` | ✅ | 鼠标悬停提示 | `"启用后会自动..."` |
| `UI类型` | ✅ | 控件类型 | `"bool"`, `"spinbox"`, `"combo"` 等 |
| `最小值` | ❌ | spinbox专用 | `0` |
| `最大值` | ❌ | spinbox专用 | `100` |
| `步进` | ❌ | spinbox专用 | `1` |
| `选项` | ❌ | combo专用 | `["选项1", "选项2"]` |
| `默认选项` | ❌ | editable_list专用 | `["默认1", "默认2"]` |

## 🔧 完整示例

### 示例：添加"自动捐兵"配置

```python
# 数据库/任务数据库.py

@dataclass
class 机器人设置:
    # ... 现有字段 ...

    # 1. 功能开关
    是否自动捐兵: bool = field(
        default=False,
        metadata={
            "显示名称": "自动捐兵",
            "描述": "启用后会自动捐赠部落请求的兵种",
            "UI类型": "bool"
        }
    )

    # 2. 捐兵策略
    捐兵策略: str = field(
        default="优先捐高级兵",
        metadata={
            "显示名称": "捐兵策略",
            "描述": "选择捐兵的优先级策略",
            "UI类型": "combo",
            "选项": ["优先捐高级兵", "优先捐低级兵", "按请求捐"]
        }
    )

    # 3. 可捐兵种
    可捐兵种: List[str] = field(
        default_factory=lambda: ["弓箭手", "巨人"],
        metadata={
            "显示名称": "可捐兵种",
            "描述": "选择可以捐赠的兵种，可自定义添加",
            "UI类型": "editable_list",
            "默认选项": ["野蛮人", "弓箭手", "巨人", "法师", "龙"]
        }
    )

    # 4. 每日上限
    每日捐兵上限: int = field(
        default=100,
        metadata={
            "显示名称": "每日捐兵上限",
            "描述": "每天最多捐赠的次数，0表示不限制",
            "UI类型": "spinbox",
            "最小值": 0,
            "最大值": 500,
            "步进": 10
        }
    )
```

### 在任务中使用

```python
# 任务流程/自动捐兵.py

from 任务流程.基础任务框架 import 基础任务

class 自动捐兵(基础任务):
    def 执行(self) -> bool:
        try:
            上下文 = self.上下文

            # 读取配置
            设置 = self.数据库.获取机器人设置(self.机器人标志)

            # 1. 检查功能是否启用
            if not 设置.是否自动捐兵:
                return True  # 功能未启用，跳过

            # 2. 读取配置
            策略 = 设置.捐兵策略
            可捐兵种 = 设置.可捐兵种
            上限 = 设置.每日捐兵上限

            上下文.置脚本状态(f"开始自动捐兵，策略：{策略}")

            # 3. 使用配置执行逻辑
            if 策略 == "优先捐高级兵":
                可捐兵种.sort(reverse=True)  # 按等级排序

            for 兵种 in 可捐兵种:
                # ... 捐兵逻辑

            return True

        except Exception as e:
            self.异常处理(e)
            return False
```

## 🧪 测试配置

### 1. 启动程序

```bash
python UI入口.py
```

### 2. 进入配置管理

在UI界面中：
1. 点击"配置管理"标签页
2. 选择一个机器人
3. 看到新增的配置项了吗？

### 3. 修改配置

1. 调整配置值
2. 点击"保存修改"
3. 重新启动机器人

### 4. 验证配置生效

在任务中打印配置：

```python
上下文.置脚本状态(f"当前配置：是否自动捐兵={设置.是否自动捐兵}")
```

## 💡 最佳实践

### ✅ 推荐做法

1. **清晰的字段名**
   ```python
   是否启用自动捐兵: bool  # ✅ 清晰
   ```

2. **详细的描述**
   ```python
   "描述": "启用后会自动检测部落请求并捐赠兵种，每小时检查一次"  # ✅ 详细
   ```

3. **合理的默认值**
   ```python
   default=False  # ✅ 新功能默认关闭
   ```

4. **使用合适的UI类型**
   ```python
   # 有限选项用 combo
   "UI类型": "combo", "选项": ["选项1", "选项2"]

   # 数字范围用 spinbox
   "UI类型": "spinbox", "最小值": 0, "最大值": 100
   ```

### ❌ 避免的做法

1. **模糊的字段名**
   ```python
   flag: bool  # ❌ 不清楚用途
   ```

2. **省略描述**
   ```python
   "UI类型": "bool"  # ❌ 缺少描述
   ```

3. **不合理的默认值**
   ```python
   default=999999  # ❌ 过大
   ```

## 🐛 故障排除

### 问题1：新字段没有显示

**检查**：
- metadata 中是否包含 `"UI类型"`
- `"UI类型"` 是否拼写正确
- 是否设置为 `"hidden"`

### 问题2：读取配置报错

**检查**：
- 字段名是否拼写正确
- 是否使用了正确的机器人标志

```python
# ✅ 正确
设置 = self.数据库.获取机器人设置(self.机器人标志)

# ❌ 错误
设置 = self.数据库.获取机器人设置("错误的标志")
```

### 问题3：修改配置后不生效

**原因**：机器人使用的是旧配置

**解决**：
1. 保存配置后
2. 停止机器人
3. 重新启动机器人

## 📚 进一步学习

想了解更多UI配置系统的细节？

查看完整文档：[UI配置系统](../核心文档/UI配置系统.md)

包含：
- 所有UI类型详解
- 数据库字段迁移
- 扩展UI类型
- 高级用法

## 🔗 相关文档

- [开发第一个任务](./02-开发第一个任务.md) - 学习任务开发
- [UI配置系统](../核心文档/UI配置系统.md) - 完整技术文档
- [提交贡献](./05-提交贡献.md) - 提交你的代码
